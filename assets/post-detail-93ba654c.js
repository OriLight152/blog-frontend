import{d as D,i as o,c,l as e,s as r,g as i,u as z,r as T,t as q,o as F,F as K,m as Q,z as Y,B as p,a as Z,q as ee,y as te,K as A,n as C,f as se,e as y,w as b,T as oe,k as R,E as ne,j as $,h as le,P as ae,Q as ie}from"./index-c038dcfe.js";import{f as O,r as re}from"./index-74aade08.js";import{N as E}from"./nprogress-a817ebd9.js";import{b as ce,e as B,f as M,s as ue,c as de}from"./post-80bc65f1.js";import{_ as j}from"./NormalButton.vue_vue_type_script_setup_true_lang-cefd2d09.js";import{I as me}from"./IconView-9e4f15bf.js";import{I as ve,a as H}from"./IconComment-0e401121.js";import{I as pe}from"./IconLikeS-a3e9f386.js";import"./_commonjsHelpers-28e086c5.js";import"./_plugin-vue_export-helper-c27b6911.js";const he={key:0},_e={class:"mt-2 text-sm text-gray-500"},fe={key:1},ge=D({__name:"CommentReply",props:{comment:null},emits:["toComment","noComment"],setup(g,{emit:d}){const w=g;function u(){w.comment?d("toComment",w.comment.cid):d("noComment")}return(a,L)=>(o(),c("div",{class:"bg-gray-300/50 w-full px-4 py-2 rounded-md my-2 cursor-pointer",onClick:u},[g.comment?(o(),c("div",he,[e("div",null,r(g.comment.user.nickname+"："+g.comment.text),1),e("div",_e,r(i(O)(g.comment.createdAt)),1)])):(o(),c("div",fe,"评论不存在或已被屏蔽"))]))}}),ke={key:0,class:"w-[200px] flex-shrink-0 hidden xl:block mr-2"},xe=e("div",{class:"font-bold text-lg"},"文章目录",-1),ye=["onClick"],we=D({__name:"SideBarPostTOC",props:{content:String},setup(g){const d=g,w=z(),u=/(#{1,6})\s(.*)/g,a=T([]),{showNav:L}=q(w);F(()=>{var h;a.value=Array(...((h=d.content)==null?void 0:h.match(u))||[])});function k(h){const t=document.getElementById(h.replace(/(#{1,6})\s/g,"").toLowerCase().replace(/\.|,|\(|\)|\//g,"").replace(/\s/g,"-"));t&&(window.scrollTo({top:t.offsetTop-70,behavior:"smooth"}),setTimeout(()=>{t.classList.add("animate-twinkle")},200),setTimeout(()=>{t.classList.remove("animate-twinkle")},2200))}return(h,t)=>a.value.length!==0?(o(),c("div",ke,[e("div",{class:Y(["fixed w-[200px] bg-white rounded-md h-fit p-2",i(L)?"top-[68px]":"top-[8px]"])},[xe,(o(!0),c(K,null,Q(a.value,m=>(o(),c("div",{class:"px-2 py-1 hover:bg-gray-500/20 rounded-md cursor-pointer",onClick:_=>k(m)},r(m.replace(/(#{1,6})\s/g,(_,v)=>"    ".repeat(v.length-1))),9,ye))),256))],2)])):p("",!0)}}),be={class:"flex justify-center w-full"},Ce={class:"w-full"},Te={key:0,class:"w-full my-2 overflow-hidden bg-white rounded-md"},Le={class:"px-8 pt-4"},Ne={class:"text-3xl leading-[60px] font-bold"},Se={class:"flex px-8 py-2 bg-gray-300/20"},$e=["src"],Pe={class:"flex flex-col"},Ie={class:"mt-2 text-lg font-bold"},Be={class:"flex items-center text-sm text-gray-500"},Oe={class:"p-8 pt-4"},De=["innerHTML"],Ve={class:"flex justify-center py-6"},Ae={class:"leading-4"},Re={class:"w-full px-4 pt-2 pb-8 my-2 overflow-hidden bg-white rounded-md",id:"comment"},Ee=e("h2",null,"评论区",-1),Me={key:0,class:"mb-2"},je=["placeholder","disabled"],He={key:0,class:"mb-4 text-center"},ze={key:1,class:"text-center"},qe={class:"p-1 mt-4"},Fe=["id"],Ke={class:"shrink-0"},Qe=["src"],Ue=["onClick"],Ge={class:"flex-1 ml-2"},Je={class:"font-bold"},We={key:0,class:"ml-1 text-sm bg-blue-300 px-1 py-0.5 rounded-md"},Xe={class:"mt-2 text-sm text-gray-500"},rt=D({__name:"post-detail",setup(g){const d=z(),w=Z(),u=ee(),{pid:a}=w.params,{navigate:L}=w.query,{login:k,likeCache:h}=q(d),t=T(),m=T([]),_=T(""),v=T(0),f=T(!1),S=te(()=>t.value&&t.value.allowComment===1);k.value&&(f.value=h.value.POST.includes(String(a))),F(()=>{window.scrollTo({top:0,behavior:"smooth"}),U().then(()=>{if(L)switch(L){case"comments":A(()=>{var s;window.scrollTo({top:((s=document.getElementById("comment"))==null?void 0:s.getBoundingClientRect().top)-65,behavior:"smooth"})});break}})});async function U(){E.start(),d.pageLoading=!0;const s=ce(Number(a)),l=B(Number(a));return Promise.all([s,l]).then(([x,P])=>{var N,n;t.value=x.post,m.value=P.comments,document.title=((N=t.value)==null?void 0:N.title)+" - "+((n=t.value)==null?void 0:n.user.nickname)+" - Ori博客"}).catch(x=>{u.error(x.message)}).finally(()=>{E.done(),d.pageLoading=!1})}function G(){if(!k.value){u.warning("请先登录");return}f.value?de(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like-=1)}).catch(s=>{u("取消点赞失败："+s.message)}).finally(()=>{let s=h.value.POST.indexOf(String(a));s!==-1&&h.value.POST.splice(s,1)}):ue(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like+=1)}).catch(s=>{f.value=!f.value,u("点赞失败："+s.message)}).finally(()=>{h.value.POST.push(String(a))})}function J(){if(_.value.trim()==""){u.warning("评论内容不可为空");return}v.value===0?M(d.token,Number(a),_.value.trim(),navigator.userAgent).then(async s=>{u.success("评论发布成功"),_.value="",m.value=(await B(Number(a))).comments}).catch(s=>{u.error("评论发布失败："+s)}):M(d.token,Number(a),_.value.trim(),navigator.userAgent,v.value).then(async s=>{u.success("评论回复成功"),_.value="",m.value=(await B(Number(a))).comments,v.value=0}).catch(s=>{u.error("评论回复失败："+s)})}function W(s){let l=document.getElementById("comment-"+s);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{l==null||l.classList.add("animate-twinkle")},200),setTimeout(()=>{l==null||l.classList.remove("animate-twinkle")},2200))}function X(s){s.style.height="100px",A(()=>{s.style.height=s.scrollHeight+"px"})}return(s,l)=>{var N;const x=le("RouterLink"),P=ie("viewer");return o(),c("div",be,[t.value?(o(),C(we,{key:0,content:t.value.text},null,8,["content"])):p("",!0),e("div",Ce,[se(s.$slots,"loading"),y(oe,{name:"popup-t"},{default:b(()=>[t.value?(o(),c("div",Te,[e("div",Le,[e("p",Ne,r(t.value.title),1)]),e("div",Se,[y(x,{to:"/user/"+t.value.user.uid},{default:b(()=>[e("img",{class:"w-12 h-12 mr-4 rounded-full",src:t.value.user.avatar,alt:"avatar"},null,8,$e)]),_:1},8,["to"]),e("div",Pe,[y(x,{to:"/user/"+t.value.user.uid},{default:b(()=>[e("span",Ie,r(t.value.user.nickname),1)]),_:1},8,["to"]),e("div",Be,[e("span",null,"发布于 "+r(i(O)(t.value.createdAt)),1),y(me,{class:"inline-block w-4 h-4 ml-2 mr-1"}),e("span",null,r(t.value.viewCount),1),y(ve,{class:"inline-block w-4 h-4 ml-2 mr-1"}),e("span",null,r(m.value.length),1),y(H,{class:"inline-block w-4 h-4 ml-2 mr-1"}),e("span",null,r(t.value.like),1)])])]),e("div",Oe,[R(e("div",{class:"leading-relaxed rendered",innerHTML:i(re)(t.value.text)},null,8,De),[[P,{viewerConfig:i(ae)}]])]),e("div",Ve,[e("button",{class:"flex flex-col items-center justify-center w-16 h-16 transition-colors border-2 border-gray-200 rounded-full hover:bg-gray-200",onClick:G},[f.value?(o(),C(pe,{key:0,class:"w-6 h-6 text-red-500"})):(o(),C(H,{key:1,class:"w-6 h-6 text-gray-500"})),e("span",Ae,r(t.value.like),1)])])])):p("",!0)]),_:1}),e("div",Re,[Ee,e("div",null,[v.value!==0?(o(),c("div",Me," 回复 "+r((N=m.value.find(n=>n.cid===v.value))==null?void 0:N.user.nickname),1)):p("",!0),R(e("textarea",{class:"w-full p-2 border rounded-md resize-none","onUpdate:modelValue":l[0]||(l[0]=n=>_.value=n),placeholder:i(S)?"发一条友善的评论":"评论区已关闭",disabled:!(i(S)&&i(k)),onInput:l[1]||(l[1]=n=>X(n.target))},null,40,je),[[ne,_.value]]),i(k)&&i(S)?(o(),C(j,{key:1,class:"mr-2",primary:"",onClick:J},{default:b(()=>[$(r(v.value===0?"发布":"回复"),1)]),_:1})):p("",!0),v.value!==0?(o(),C(j,{key:2,class:"mr-2",onClick:l[2]||(l[2]=n=>v.value=0)},{default:b(()=>[$("取消回复")]),_:1})):p("",!0)]),i(k)?p("",!0):(o(),c("p",He,[$("登录后才可发表评论 "),y(x,{to:"/login",class:"text-blue-800"},{default:b(()=>[$(" 去登录")]),_:1})])),m.value.length===0?(o(),c("p",ze,"暂无评论")):p("",!0),e("div",qe,[(o(!0),c(K,null,Q(m.value,n=>{var V;return o(),c("div",{class:"flex py-2 my-2",id:"comment-"+n.cid},[e("div",Ke,[y(x,{to:"/user/"+n.user.uid},{default:b(()=>[e("img",{class:"w-12 h-12 rounded-full",src:n.user.avatar},null,8,Qe)]),_:2},1032,["to"]),i(k)&&i(S)?(o(),c("button",{key:0,class:"w-12 text-sm text-center",onClick:I=>v.value=n.cid},"回复",8,Ue)):p("",!0)]),e("div",Ge,[e("div",null,[e("span",Je,r(n.user.nickname),1),((V=t.value)==null?void 0:V.author)===n.user.uid?(o(),c("span",We,"文章作者")):p("",!0)]),n.replyTo?(o(),C(ge,{key:0,comment:m.value.find(I=>I.cid===n.replyTo),onToComment:W,onNoComment:l[3]||(l[3]=I=>i(u).warning("评论不存在或已被屏蔽"))},null,8,["comment"])):p("",!0),e("div",null,r(n.text),1),e("div",Xe,r(i(O)(n.createdAt)),1)])],8,Fe)}),256))])])])])}}});export{rt as default};
