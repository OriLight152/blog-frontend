import{d as D,h as n,c as r,k as e,q as i,f as u,u as j,r as T,t as E,o as H,F as q,l as z,y as Q,A as p,a as W,n as X,x as Y,m as C,e as y,w as b,T as Z,j as ee,D as te,i as I,J as se,g as ne}from"./index-10d97bec.js";import{f as B,r as oe}from"./index-74aade08.js";import{N as A}from"./nprogress-a817ebd9.js";import{b as le,e as O,n as V,s as ae,c as ie}from"./post-471e27b3.js";import{_ as R}from"./NormalButton.vue_vue_type_script_setup_true_lang-c36d645a.js";import{I as re}from"./IconView-a9988df5.js";import{I as ce,a as M}from"./IconComment-dbbd9bbf.js";import{I as ue}from"./IconLikeS-de67a334.js";import"./_commonjsHelpers-28e086c5.js";import"./_plugin-vue_export-helper-c27b6911.js";const de={key:0},me={class:"mt-2 text-sm text-gray-500"},ve={key:1},pe=D({__name:"CommentReply",props:{comment:null},emits:["toComment","noComment"],setup(g,{emit:d}){const w=g;function c(){w.comment?d("toComment",w.comment.cid):d("noComment")}return(a,L)=>(n(),r("div",{class:"bg-gray-300/50 w-full px-4 py-2 rounded-md my-2 cursor-pointer",onClick:c},[g.comment?(n(),r("div",de,[e("div",null,i(g.comment.user.nickname+"："+g.comment.text),1),e("div",me,i(u(B)(g.comment.createdAt)),1)])):(n(),r("div",ve,"评论不存在或已被屏蔽"))]))}}),_e={key:0,class:"w-[200px] flex-shrink-0 hidden xl:block mr-2"},he=e("div",{class:"font-bold text-lg"},"文章目录",-1),fe=["onClick"],ge=D({__name:"SideBarPostTOC",props:{content:String},setup(g){const d=g,w=j(),c=/(#{1,6})\s(.*)/g,a=T([]),{showNav:L}=E(w);H(()=>{var _;a.value=Array(...((_=d.content)==null?void 0:_.match(c))||[])});function k(_){const t=document.getElementById(_.replace(/(#{1,6})\s/g,"").toLowerCase().replace(/\.|,|\(|\)|\//g,"").replace(/\s/g,"-"));t&&(window.scrollTo({top:t.offsetTop-70,behavior:"smooth"}),setTimeout(()=>{t.classList.add("animate-twinkle")},200),setTimeout(()=>{t.classList.remove("animate-twinkle")},2200))}return(_,t)=>a.value.length!==0?(n(),r("div",_e,[e("div",{class:Q(["fixed w-[200px] bg-white rounded-md h-fit p-2",u(L)?"top-[68px]":"top-[8px]"])},[he,(n(!0),r(q,null,z(a.value,m=>(n(),r("div",{class:"px-2 py-1 hover:bg-gray-500/20 rounded-md cursor-pointer",onClick:h=>k(m)},i(m.replace(/(#{1,6})\s/g,(h,v)=>"    ".repeat(v.length-1))),9,fe))),256))],2)])):p("",!0)}}),ke={class:"w-full flex justify-center"},xe={class:"w-full"},ye={key:0,class:"w-full bg-white my-2 rounded-md overflow-hidden"},we={class:"px-8 pt-4"},be={class:"text-3xl leading-[60px] font-bold"},Ce={class:"flex px-8 py-2 bg-gray-300/20"},Te=["src"],Le={class:"flex flex-col"},Ne={class:"mt-2 text-lg font-bold"},Se={class:"text-gray-500 flex items-center text-sm"},$e={class:"p-8 pt-4"},Ie=["innerHTML"],Pe={class:"flex justify-center py-6"},Oe={class:"leading-4"},Be={class:"w-full bg-white my-2 rounded-md overflow-hidden px-4 pt-2 pb-8",id:"comment"},De=e("h2",null,"评论区",-1),Ae={key:0,class:"mb-2"},Ve=["placeholder","disabled"],Re={key:0,class:"text-center mb-4"},Me={key:1,class:"text-center"},je={class:"mt-4 p-1"},Ee=["id"],He={class:"shrink-0"},qe=["src"],ze=["onClick"],Fe={class:"ml-2 flex-1"},Je={class:"font-bold"},Ue={key:0,class:"ml-1 text-sm bg-blue-300 px-1 py-0.5 rounded-md"},Ge={class:"mt-2 text-sm text-gray-500"},ot=D({__name:"post-detail",setup(g){const d=j(),w=W(),c=X(),{pid:a}=w.params,{navigate:L}=w.query,{login:k,likeCache:_}=E(d),t=T(),m=T([]),h=T(""),v=T(0),f=T(!1),S=Y(()=>t.value&&t.value.allowComment===1);k.value&&(f.value=_.value.POST.includes(String(a))),H(()=>{F().then(()=>{var s;if(L)switch(L){case"comments":window.scrollTo({top:((s=document.getElementById("comment"))==null?void 0:s.getBoundingClientRect().top)-65,behavior:"smooth"});break}})});async function F(){A.start(),d.pageLoading=!0;const s=le(Number(a)),l=O(Number(a));return Promise.all([s,l]).then(([x,$])=>{var o,N;t.value=x.post,m.value=$.comments,document.title=((o=t.value)==null?void 0:o.title)+" - "+((N=t.value)==null?void 0:N.user.nickname)+" - Ori博客"}).catch(x=>{c.error(x.message)}).finally(()=>{A.done(),d.pageLoading=!1})}function J(){if(!k.value){c.warning("请先登录");return}f.value?ie(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like-=1)}).catch(s=>{c("取消点赞失败："+s.message)}).finally(()=>{let s=_.value.POST.indexOf(String(a));s!==-1&&_.value.POST.splice(s,1)}):ae(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like+=1)}).catch(s=>{f.value=!f.value,c("点赞失败："+s.message)}).finally(()=>{_.value.POST.push(String(a))})}function U(){if(h.value.trim()==""){c.warning("评论内容不可为空");return}v.value===0?V(d.token,Number(a),h.value.trim(),navigator.userAgent).then(async s=>{c.success("评论发布成功"),h.value="",m.value=(await O(Number(a))).comments}).catch(s=>{c.error("评论发布失败："+s)}):V(d.token,Number(a),h.value.trim(),navigator.userAgent,v.value).then(async s=>{c.success("评论回复成功"),h.value="",m.value=(await O(Number(a))).comments,v.value=0}).catch(s=>{c.error("评论回复失败："+s)})}function G(s){let l=document.getElementById("comment-"+s);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{l==null||l.classList.add("animate-twinkle")},200),setTimeout(()=>{l==null||l.classList.remove("animate-twinkle")},2200))}function K(s){s.style.height="100px",se(()=>{s.style.height=s.scrollHeight+"px"})}return(s,l)=>{var $;const x=ne("RouterLink");return n(),r("div",ke,[t.value?(n(),C(ge,{key:0,content:t.value.text},null,8,["content"])):p("",!0),e("div",xe,[y(Z,null,{default:b(()=>[t.value?(n(),r("div",ye,[e("div",we,[e("p",be,i(t.value.title),1)]),e("div",Ce,[y(x,{to:"/user/"+t.value.user.uid},{default:b(()=>[e("img",{class:"rounded-full w-12 h-12 mr-4",src:t.value.user.avatar,alt:"avatar"},null,8,Te)]),_:1},8,["to"]),e("div",Le,[y(x,{to:"/user/"+t.value.user.uid},{default:b(()=>[e("span",Ne,i(t.value.user.nickname),1)]),_:1},8,["to"]),e("div",Se,[e("span",null,"发布于 "+i(u(B)(t.value.createdAt)),1),y(re,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(t.value.viewCount),1),y(ce,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(m.value.length),1),y(M,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(t.value.like),1)])])]),e("div",$e,[e("div",{class:"leading-relaxed rendered",innerHTML:u(oe)(t.value.text)},null,8,Ie)]),e("div",Pe,[e("button",{class:"w-16 h-16 border-2 flex flex-col items-center justify-center rounded-full border-gray-200 hover:bg-gray-200 transition-colors",onClick:J},[f.value?(n(),C(ue,{key:0,class:"w-6 h-6 text-red-500"})):(n(),C(M,{key:1,class:"w-6 h-6 text-gray-500"})),e("span",Oe,i(t.value.like),1)])])])):p("",!0)]),_:1}),e("div",Be,[De,e("div",null,[v.value!==0?(n(),r("div",Ae," 回复 "+i(($=m.value.find(o=>o.cid===v.value))==null?void 0:$.user.nickname),1)):p("",!0),ee(e("textarea",{class:"w-full p-2 rounded-md border resize-none","onUpdate:modelValue":l[0]||(l[0]=o=>h.value=o),placeholder:u(S)?"发一条友善的评论":"评论区已关闭",disabled:!(u(S)&&u(k)),onInput:l[1]||(l[1]=o=>K(o.target))},null,40,Ve),[[te,h.value]]),u(k)&&u(S)?(n(),C(R,{key:1,class:"mr-2",primary:"",onClick:U},{default:b(()=>[I(i(v.value===0?"发布":"回复"),1)]),_:1})):p("",!0),v.value!==0?(n(),C(R,{key:2,class:"mr-2",onClick:l[2]||(l[2]=o=>v.value=0)},{default:b(()=>[I("取消回复")]),_:1})):p("",!0)]),u(k)?p("",!0):(n(),r("p",Re,[I("登录后才可发表评论 "),y(x,{to:"/login",class:"text-blue-800"},{default:b(()=>[I(" 去登录")]),_:1})])),m.value.length===0?(n(),r("p",Me,"暂无评论")):p("",!0),e("div",je,[(n(!0),r(q,null,z(m.value,o=>{var N;return n(),r("div",{class:"my-2 py-2 flex",id:"comment-"+o.cid},[e("div",He,[y(x,{to:"/user/"+o.user.uid},{default:b(()=>[e("img",{class:"w-12 h-12 rounded-full",src:o.user.avatar},null,8,qe)]),_:2},1032,["to"]),u(k)&&u(S)?(n(),r("button",{key:0,class:"w-12 text-center text-sm",onClick:P=>v.value=o.cid},"回复",8,ze)):p("",!0)]),e("div",Fe,[e("div",null,[e("span",Je,i(o.user.nickname),1),((N=t.value)==null?void 0:N.author)===o.user.uid?(n(),r("span",Ue,"文章作者")):p("",!0)]),o.replyTo?(n(),C(pe,{key:0,comment:m.value.find(P=>P.cid===o.replyTo),onToComment:G,onNoComment:l[3]||(l[3]=P=>u(c).warning("评论不存在或已被屏蔽"))},null,8,["comment"])):p("",!0),e("div",null,i(o.text),1),e("div",Ge,i(u(B)(o.createdAt)),1)])],8,Ee)}),256))])])])])}}});export{ot as default};
