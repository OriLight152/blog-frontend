import{d as V,i as n,c as r,m as e,n as i,g as u,u as E,r as T,t as H,o as z,F as O,f as F,v as Q,y as p,a as W,l as X,s as Y,k as b,e as w,w as C,B as Z,C as ee,j as I,I as te,h as se}from"./index-1dfb2302.js";import{f as D,r as ne}from"./index-74aade08.js";import{N as A}from"./nprogress-a817ebd9.js";import{b as oe,e as B,s as le,c as ae,n as R}from"./post-f9c9a4a4.js";import{_ as M}from"./NormalButton.vue_vue_type_script_setup_true_lang-0abceca8.js";import{I as ie,a as re,b as j}from"./IconView-03c59b79.js";import{I as ce}from"./IconLikeS-14d50311.js";import"./_commonjsHelpers-28e086c5.js";import"./_plugin-vue_export-helper-c27b6911.js";const ue={key:0},de={class:"mt-2 text-sm text-gray-500"},me={key:1},ve=V({__name:"CommentReply",props:{comment:null},emits:["toComment","noComment"],setup(g,{emit:d}){const y=g;function c(){y.comment?d("toComment",y.comment.cid):d("noComment")}return(a,L)=>(n(),r("div",{class:"bg-gray-300/50 w-full px-4 py-2 rounded-md my-2 cursor-pointer",onClick:c},[g.comment?(n(),r("div",ue,[e("div",null,i(g.comment.user.nickname+"："+g.comment.text),1),e("div",de,i(u(D)(g.comment.createdAt)),1)])):(n(),r("div",me,"评论不存在或已被屏蔽"))]))}}),pe={key:0,class:"w-[200px] flex-shrink-0 hidden xl:block mr-2"},he=e("div",{class:"font-bold text-lg"},"文章目录",-1),_e=["onClick"],fe=V({__name:"SideBarPostTOC",props:{content:String},setup(g){const d=g,y=E(),c=/(#{1,6})\s(.*)/g,a=T([]),{showNav:L}=H(y);z(()=>{var h;a.value=Array(...((h=d.content)==null?void 0:h.match(c))||[])});function k(h){const t=document.getElementById(h.replace(/(#{1,6})\s/g,"").toLowerCase().replace(/\.|,|\(|\)|\//g,"").replace(/\s/g,"-"));t&&(window.scrollTo({top:t.offsetTop-70,behavior:"smooth"}),setTimeout(()=>{t.classList.add("animate-twinkle")},200),setTimeout(()=>{t.classList.remove("animate-twinkle")},2200))}return(h,t)=>a.value.length!==0?(n(),r("div",pe,[e("div",{class:Q(["fixed w-[200px] bg-white rounded-md h-fit p-2",u(L)?"top-[68px]":"top-[8px]"])},[he,(n(!0),r(O,null,F(a.value,m=>(n(),r("div",{class:"px-2 py-1 hover:bg-gray-500/20 rounded-md cursor-pointer",onClick:_=>k(m)},i(m.replace(/(#{1,6})\s/g,(_,v)=>"    ".repeat(v.length-2))),9,_e))),256))],2)])):p("",!0)}}),ge={class:"w-full flex justify-center"},ke={class:"w-full"},xe={class:"w-full bg-white my-2 rounded-md overflow-hidden"},ye={class:"px-8 pt-4"},we={class:"text-3xl leading-[60px] font-bold"},be={class:"flex px-8 py-2 bg-gray-300/20"},Ce=["src"],Te={class:"flex flex-col"},Le={class:"mt-2 text-lg font-bold"},Ne={class:"text-gray-500 flex items-center text-sm"},Se={class:"p-8 pt-4"},$e=["innerHTML"],Ie={class:"flex justify-center py-6"},Pe={class:"leading-4"},Be={class:"w-full bg-white my-2 rounded-md overflow-hidden px-4 pt-2 pb-8",id:"comment"},Oe=e("h2",null,"评论区",-1),De={key:0,class:"mb-2"},Ve=["placeholder","disabled"],Ae={key:0,class:"text-center mb-4"},Re={key:1,class:"text-center"},Me={class:"mt-4 p-1"},je=["id"],Ee={class:"shrink-0"},He=["src"],ze=["onClick"],Fe={class:"ml-2 flex-1"},qe={class:"font-bold"},Ue={key:0,class:"ml-1 text-sm bg-blue-300 px-1 py-0.5 rounded-md"},Ge={class:"mt-2 text-sm text-gray-500"},st=V({__name:"post-detail",setup(g){const d=E(),y=W(),c=X(),{pid:a}=y.params,{navigate:L}=y.query,{login:k,likeCache:h}=H(d),t=T(),m=T([]),_=T(""),v=T(0),f=T(!1),S=Y(()=>t.value&&t.value.allowComment===1);k.value&&(f.value=h.value.POST.includes(String(a))),z(()=>{q().then(()=>{var s;if(L)switch(L){case"comments":window.scrollTo({top:((s=document.getElementById("comment"))==null?void 0:s.getBoundingClientRect().top)-65,behavior:"smooth"});break}})});async function q(){A.start(),d.pageLoading=!0;const s=oe(Number(a)),l=B(Number(a));return Promise.all([s,l]).then(([x,$])=>{var o,N;t.value=x.post,m.value=$.comments,document.title=((o=t.value)==null?void 0:o.title)+" - "+((N=t.value)==null?void 0:N.user.nickname)+" - Ori博客"}).catch(x=>{c.error(x.message)}).finally(()=>{A.done(),d.pageLoading=!1})}function U(){if(!k.value){c.warning("请先登录");return}f.value?ae(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like-=1)}).catch(s=>{c("取消点赞失败："+s.message)}).finally(()=>{let s=h.value.POST.indexOf(String(a));s!==-1&&h.value.POST.splice(s,1)}):le(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like+=1)}).catch(s=>{f.value=!f.value,c("点赞失败："+s.message)}).finally(()=>{h.value.POST.push(String(a))})}function G(){if(_.value.trim()==""){c.warning("评论内容不可为空");return}v.value===0?R(d.token,Number(a),_.value.trim(),navigator.userAgent).then(async s=>{c.success("评论发布成功"),_.value="",m.value=(await B(Number(a))).comments}).catch(s=>{c.error("评论发布失败："+s)}):R(d.token,Number(a),_.value.trim(),navigator.userAgent,v.value).then(async s=>{c.success("评论回复成功"),_.value="",m.value=(await B(Number(a))).comments,v.value=0}).catch(s=>{c.error("评论回复失败："+s)})}function J(s){let l=document.getElementById("comment-"+s);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{l==null||l.classList.add("animate-twinkle")},200),setTimeout(()=>{l==null||l.classList.remove("animate-twinkle")},2200))}function K(s){s.style.height="100px",te(()=>{s.style.height=s.scrollHeight+"px"})}return(s,l)=>{var $;const x=se("RouterLink");return n(),r("div",ge,[t.value?(n(),b(fe,{key:0,content:t.value.text},null,8,["content"])):p("",!0),e("div",ke,[e("div",xe,[t.value?(n(),r(O,{key:0},[e("div",ye,[e("p",we,i(t.value.title),1)]),e("div",be,[w(x,{to:"/user/"+t.value.user.uid},{default:C(()=>[e("img",{class:"rounded-full w-12 h-12 mr-4",src:t.value.user.avatar,alt:"avatar"},null,8,Ce)]),_:1},8,["to"]),e("div",Te,[w(x,{to:"/user/"+t.value.user.uid},{default:C(()=>[e("span",Le,i(t.value.user.nickname),1)]),_:1},8,["to"]),e("div",Ne,[e("span",null,"发布于 "+i(u(D)(t.value.createdAt)),1),w(ie,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(t.value.viewCount),1),w(re,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(m.value.length),1),w(j,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(t.value.like),1)])])]),e("div",Se,[e("div",{class:"leading-relaxed rendered",innerHTML:u(ne)(t.value.text)},null,8,$e)]),e("div",Ie,[e("button",{class:"w-16 h-16 border-2 flex flex-col items-center justify-center rounded-full border-gray-200 hover:bg-gray-200 transition-colors",onClick:U},[f.value?(n(),b(ce,{key:0,class:"w-6 h-6 text-red-500"})):(n(),b(j,{key:1,class:"w-6 h-6 text-gray-500"})),e("span",Pe,i(t.value.like),1)])])],64)):p("",!0)]),e("div",Be,[Oe,e("div",null,[v.value!==0?(n(),r("div",De," 回复 "+i(($=m.value.find(o=>o.cid===v.value))==null?void 0:$.user.nickname),1)):p("",!0),Z(e("textarea",{class:"w-full p-2 rounded-md border resize-none","onUpdate:modelValue":l[0]||(l[0]=o=>_.value=o),placeholder:u(S)?"发一条友善的评论":"评论区已关闭",disabled:!(u(S)&&u(k)),onInput:l[1]||(l[1]=o=>K(o.target))},null,40,Ve),[[ee,_.value]]),u(k)&&u(S)?(n(),b(M,{key:1,class:"mr-2",primary:"",onClick:G},{default:C(()=>[I(i(v.value===0?"发布":"回复"),1)]),_:1})):p("",!0),v.value!==0?(n(),b(M,{key:2,class:"mr-2",onClick:l[2]||(l[2]=o=>v.value=0)},{default:C(()=>[I("取消回复")]),_:1})):p("",!0)]),u(k)?p("",!0):(n(),r("p",Ae,[I("登录后才可发表评论 "),w(x,{to:"/login",class:"text-blue-800"},{default:C(()=>[I(" 去登录")]),_:1})])),m.value.length===0?(n(),r("p",Re,"暂无评论")):p("",!0),e("div",Me,[(n(!0),r(O,null,F(m.value,o=>{var N;return n(),r("div",{class:"my-2 py-2 flex",id:"comment-"+o.cid},[e("div",Ee,[w(x,{to:"/user/"+o.user.uid},{default:C(()=>[e("img",{class:"w-12 h-12 rounded-full",src:o.user.avatar},null,8,He)]),_:2},1032,["to"]),u(k)&&u(S)?(n(),r("button",{key:0,class:"w-12 text-center text-sm",onClick:P=>v.value=o.cid},"回复",8,ze)):p("",!0)]),e("div",Fe,[e("div",null,[e("span",qe,i(o.user.nickname),1),((N=t.value)==null?void 0:N.author)===o.user.uid?(n(),r("span",Ue,"文章作者")):p("",!0)]),o.replyTo?(n(),b(ve,{key:0,comment:m.value.find(P=>P.cid===o.replyTo),onToComment:J,onNoComment:l[3]||(l[3]=P=>u(c).warning("评论不存在或已被屏蔽"))},null,8,["comment"])):p("",!0),e("div",null,i(o.text),1),e("div",Ge,i(u(D)(o.createdAt)),1)])],8,je)}),256))])])])])}}});export{st as default};
