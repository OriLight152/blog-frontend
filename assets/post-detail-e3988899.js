import{d as D,i as o,c as r,l as e,s as i,g as u,u as M,r as T,t as j,o as H,F as z,m as q,z as Q,B as p,a as W,q as X,y as Y,n as C,f as Z,e as y,w as b,T as ee,k as te,E as se,j as I,K as oe,h as ne}from"./index-bca94e4a.js";import{f as O,r as le}from"./index-74aade08.js";import{N as V}from"./nprogress-a817ebd9.js";import{b as ae,e as B,f as A,s as ie,c as re}from"./post-7da5c150.js";import{_ as R}from"./NormalButton.vue_vue_type_script_setup_true_lang-41fd96a7.js";import{I as ce}from"./IconView-53c73157.js";import{I as ue,a as E}from"./IconComment-7e3597d0.js";import{I as de}from"./IconLikeS-267d64e7.js";import"./_commonjsHelpers-28e086c5.js";import"./_plugin-vue_export-helper-c27b6911.js";const me={key:0},ve={class:"mt-2 text-sm text-gray-500"},pe={key:1},he=D({__name:"CommentReply",props:{comment:null},emits:["toComment","noComment"],setup(g,{emit:d}){const w=g;function c(){w.comment?d("toComment",w.comment.cid):d("noComment")}return(a,L)=>(o(),r("div",{class:"bg-gray-300/50 w-full px-4 py-2 rounded-md my-2 cursor-pointer",onClick:c},[g.comment?(o(),r("div",me,[e("div",null,i(g.comment.user.nickname+"："+g.comment.text),1),e("div",ve,i(u(O)(g.comment.createdAt)),1)])):(o(),r("div",pe,"评论不存在或已被屏蔽"))]))}}),_e={key:0,class:"w-[200px] flex-shrink-0 hidden xl:block mr-2"},fe=e("div",{class:"font-bold text-lg"},"文章目录",-1),ge=["onClick"],ke=D({__name:"SideBarPostTOC",props:{content:String},setup(g){const d=g,w=M(),c=/(#{1,6})\s(.*)/g,a=T([]),{showNav:L}=j(w);H(()=>{var h;a.value=Array(...((h=d.content)==null?void 0:h.match(c))||[])});function k(h){const t=document.getElementById(h.replace(/(#{1,6})\s/g,"").toLowerCase().replace(/\.|,|\(|\)|\//g,"").replace(/\s/g,"-"));t&&(window.scrollTo({top:t.offsetTop-70,behavior:"smooth"}),setTimeout(()=>{t.classList.add("animate-twinkle")},200),setTimeout(()=>{t.classList.remove("animate-twinkle")},2200))}return(h,t)=>a.value.length!==0?(o(),r("div",_e,[e("div",{class:Q(["fixed w-[200px] bg-white rounded-md h-fit p-2",u(L)?"top-[68px]":"top-[8px]"])},[fe,(o(!0),r(z,null,q(a.value,m=>(o(),r("div",{class:"px-2 py-1 hover:bg-gray-500/20 rounded-md cursor-pointer",onClick:_=>k(m)},i(m.replace(/(#{1,6})\s/g,(_,v)=>"    ".repeat(v.length-1))),9,ge))),256))],2)])):p("",!0)}}),xe={class:"w-full flex justify-center"},ye={class:"w-full"},we={key:0,class:"w-full bg-white my-2 rounded-md overflow-hidden"},be={class:"px-8 pt-4"},Ce={class:"text-3xl leading-[60px] font-bold"},Te={class:"flex px-8 py-2 bg-gray-300/20"},Le=["src"],Ne={class:"flex flex-col"},Se={class:"mt-2 text-lg font-bold"},$e={class:"text-gray-500 flex items-center text-sm"},Ie={class:"p-8 pt-4"},Pe=["innerHTML"],Be={class:"flex justify-center py-6"},Oe={class:"leading-4"},De={class:"w-full bg-white my-2 rounded-md overflow-hidden px-4 pt-2 pb-8",id:"comment"},Ve=e("h2",null,"评论区",-1),Ae={key:0,class:"mb-2"},Re=["placeholder","disabled"],Ee={key:0,class:"text-center mb-4"},Me={key:1,class:"text-center"},je={class:"mt-4 p-1"},He=["id"],ze={class:"shrink-0"},qe=["src"],Fe=["onClick"],Ke={class:"ml-2 flex-1"},Ue={class:"font-bold"},Ge={key:0,class:"ml-1 text-sm bg-blue-300 px-1 py-0.5 rounded-md"},Je={class:"mt-2 text-sm text-gray-500"},lt=D({__name:"post-detail",setup(g){const d=M(),w=W(),c=X(),{pid:a}=w.params,{navigate:L}=w.query,{login:k,likeCache:h}=j(d),t=T(),m=T([]),_=T(""),v=T(0),f=T(!1),S=Y(()=>t.value&&t.value.allowComment===1);k.value&&(f.value=h.value.POST.includes(String(a))),H(()=>{F().then(()=>{var s;if(L)switch(L){case"comments":window.scrollTo({top:((s=document.getElementById("comment"))==null?void 0:s.getBoundingClientRect().top)-65,behavior:"smooth"});break}})});async function F(){V.start(),d.pageLoading=!0;const s=ae(Number(a)),l=B(Number(a));return Promise.all([s,l]).then(([x,$])=>{var n,N;t.value=x.post,m.value=$.comments,document.title=((n=t.value)==null?void 0:n.title)+" - "+((N=t.value)==null?void 0:N.user.nickname)+" - Ori博客"}).catch(x=>{c.error(x.message)}).finally(()=>{V.done(),d.pageLoading=!1})}function K(){if(!k.value){c.warning("请先登录");return}f.value?re(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like-=1)}).catch(s=>{c("取消点赞失败："+s.message)}).finally(()=>{let s=h.value.POST.indexOf(String(a));s!==-1&&h.value.POST.splice(s,1)}):ie(d.token,"POST",Number(a)).then(s=>{f.value=!f.value,t.value&&(t.value.like+=1)}).catch(s=>{f.value=!f.value,c("点赞失败："+s.message)}).finally(()=>{h.value.POST.push(String(a))})}function U(){if(_.value.trim()==""){c.warning("评论内容不可为空");return}v.value===0?A(d.token,Number(a),_.value.trim(),navigator.userAgent).then(async s=>{c.success("评论发布成功"),_.value="",m.value=(await B(Number(a))).comments}).catch(s=>{c.error("评论发布失败："+s)}):A(d.token,Number(a),_.value.trim(),navigator.userAgent,v.value).then(async s=>{c.success("评论回复成功"),_.value="",m.value=(await B(Number(a))).comments,v.value=0}).catch(s=>{c.error("评论回复失败："+s)})}function G(s){let l=document.getElementById("comment-"+s);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{l==null||l.classList.add("animate-twinkle")},200),setTimeout(()=>{l==null||l.classList.remove("animate-twinkle")},2200))}function J(s){s.style.height="100px",oe(()=>{s.style.height=s.scrollHeight+"px"})}return(s,l)=>{var $;const x=ne("RouterLink");return o(),r("div",xe,[t.value?(o(),C(ke,{key:0,content:t.value.text},null,8,["content"])):p("",!0),e("div",ye,[Z(s.$slots,"loading"),y(ee,{name:"popup-t"},{default:b(()=>[t.value?(o(),r("div",we,[e("div",be,[e("p",Ce,i(t.value.title),1)]),e("div",Te,[y(x,{to:"/user/"+t.value.user.uid},{default:b(()=>[e("img",{class:"rounded-full w-12 h-12 mr-4",src:t.value.user.avatar,alt:"avatar"},null,8,Le)]),_:1},8,["to"]),e("div",Ne,[y(x,{to:"/user/"+t.value.user.uid},{default:b(()=>[e("span",Se,i(t.value.user.nickname),1)]),_:1},8,["to"]),e("div",$e,[e("span",null,"发布于 "+i(u(O)(t.value.createdAt)),1),y(ce,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(t.value.viewCount),1),y(ue,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(m.value.length),1),y(E,{class:"w-4 h-4 inline-block ml-2 mr-1"}),e("span",null,i(t.value.like),1)])])]),e("div",Ie,[e("div",{class:"leading-relaxed rendered",innerHTML:u(le)(t.value.text)},null,8,Pe)]),e("div",Be,[e("button",{class:"w-16 h-16 border-2 flex flex-col items-center justify-center rounded-full border-gray-200 hover:bg-gray-200 transition-colors",onClick:K},[f.value?(o(),C(de,{key:0,class:"w-6 h-6 text-red-500"})):(o(),C(E,{key:1,class:"w-6 h-6 text-gray-500"})),e("span",Oe,i(t.value.like),1)])])])):p("",!0)]),_:1}),e("div",De,[Ve,e("div",null,[v.value!==0?(o(),r("div",Ae," 回复 "+i(($=m.value.find(n=>n.cid===v.value))==null?void 0:$.user.nickname),1)):p("",!0),te(e("textarea",{class:"w-full p-2 rounded-md border resize-none","onUpdate:modelValue":l[0]||(l[0]=n=>_.value=n),placeholder:u(S)?"发一条友善的评论":"评论区已关闭",disabled:!(u(S)&&u(k)),onInput:l[1]||(l[1]=n=>J(n.target))},null,40,Re),[[se,_.value]]),u(k)&&u(S)?(o(),C(R,{key:1,class:"mr-2",primary:"",onClick:U},{default:b(()=>[I(i(v.value===0?"发布":"回复"),1)]),_:1})):p("",!0),v.value!==0?(o(),C(R,{key:2,class:"mr-2",onClick:l[2]||(l[2]=n=>v.value=0)},{default:b(()=>[I("取消回复")]),_:1})):p("",!0)]),u(k)?p("",!0):(o(),r("p",Ee,[I("登录后才可发表评论 "),y(x,{to:"/login",class:"text-blue-800"},{default:b(()=>[I(" 去登录")]),_:1})])),m.value.length===0?(o(),r("p",Me,"暂无评论")):p("",!0),e("div",je,[(o(!0),r(z,null,q(m.value,n=>{var N;return o(),r("div",{class:"my-2 py-2 flex",id:"comment-"+n.cid},[e("div",ze,[y(x,{to:"/user/"+n.user.uid},{default:b(()=>[e("img",{class:"w-12 h-12 rounded-full",src:n.user.avatar},null,8,qe)]),_:2},1032,["to"]),u(k)&&u(S)?(o(),r("button",{key:0,class:"w-12 text-center text-sm",onClick:P=>v.value=n.cid},"回复",8,Fe)):p("",!0)]),e("div",Ke,[e("div",null,[e("span",Ue,i(n.user.nickname),1),((N=t.value)==null?void 0:N.author)===n.user.uid?(o(),r("span",Ge,"文章作者")):p("",!0)]),n.replyTo?(o(),C(he,{key:0,comment:m.value.find(P=>P.cid===n.replyTo),onToComment:G,onNoComment:l[3]||(l[3]=P=>u(c).warning("评论不存在或已被屏蔽"))},null,8,["comment"])):p("",!0),e("div",null,i(n.text),1),e("div",Je,i(u(O)(n.createdAt)),1)])],8,He)}),256))])])])])}}});export{lt as default};
